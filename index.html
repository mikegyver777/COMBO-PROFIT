<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Invoice Sheet & Profit Calculator - Alta Cal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 0; }
        input, select, button { font-size: 16px !important; }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: #f5f5f5;
            padding: 15px 15px 10px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .container { max-width: 1400px; margin: 0 auto; }
        .scrollable-content { padding: 0 15px 15px 15px; }
        
        .btn { padding: 14px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; touch-action: manipulation; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-red { background: #EF5350; color: white; }
        
        .header { background: white; border-radius: 12px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header h1 { color: #1976D2; font-size: 24px; margin-bottom: 15px; }
        .header-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .invoice-sheet {
            background: white;
            border: 3px solid #2196F3;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .invoice-header {
            background: #2196F3;
            color: white;
            padding: 10px;
            margin: -15px -15px 15px -15px;
            border-radius: 9px 9px 0 0;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
        }
        
        .invoice-section {
            margin-bottom: 10px;
            border: 2px solid #333;
            padding: 8px;
            background-color: #fff;
        }
        
        .invoice-section-header {
            background-color: #000;
            color: white;
            padding: 6px 10px;
            font-weight: bold;
            margin: -8px -8px 8px -8px;
            font-size: 14px;
        }
        
        .bank-info {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .amount-display {
            font-size: 24px;
            font-weight: bold;
            color: #000;
            padding: 8px;
            background-color: #f0f0f0;
            border: 1px solid #999;
            text-align: right;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }
        
        .invoice-table th, .invoice-table td {
            border: 1px solid #333;
            padding: 4px 6px;
            text-align: left;
        }
        
        .invoice-table th {
            background-color: #f0f0f0;
            font-weight: bold;
            font-size: 13px;
        }
        
        .invoice-table td input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 2px;
            font-size: 13px;
        }
        
        .summary-section-invoice {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 8px;
        }
        
        .summary-item-invoice {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .summary-label-invoice {
            font-weight: bold;
            background-color: #000;
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 13px;
        }
        
        .summary-value-invoice {
            background-color: #f0f0f0;
            border: 1px solid #999;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            font-size: 20px;
            min-height: 45px;
        }
        
        .auto-filled {
            background-color: #E3F2FD !important;
            border: 2px solid #2196F3 !important;
        }
        
        .week-input { background: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: center; }
        .week-input input { font-size: 16px; padding: 12px; border: 2px solid #2196F3; border-radius: 6px; width: 100%; max-width: 400px; }
        
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 0; }
        .summary-card { background: linear-gradient(135deg, var(--c1), var(--c2)); padding: 15px; border-radius: 8px; color: white; text-align: center; }
        .summary-card.blue { --c1: #42A5F5; --c2: #2196F3; }
        .summary-card.purple { --c1: #AB47BC; --c2: #9C27B0; }
        .summary-card.green { --c1: #4CAF50; --c2: #45a049; }
        .summary-card.red { --c1: #EF5350; --c2: #E53935; }
        .summary-card .label { font-size: 11px; font-weight: 600; margin-bottom: 5px; }
        .summary-card .value { font-size: 20px; font-weight: 700; }
        
        .calculator { background: white; border: 3px solid #ccc; border-radius: 12px; margin-bottom: 20px; position: relative; }
        .calc-header { background: #BBDEFB; padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; }
        .delete-btn { position: absolute; top: -10px; right: -10px; background: #EF5350; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; font-size: 20px; cursor: pointer; z-index: 10; }
        
        .calc-section { padding: 20px; }
        .section { margin-bottom: 20px; border: 3px solid #e0e0e0; border-radius: 8px; }
        .section-header { padding: 12px; font-weight: 600; text-align: center; }
        .section-header.blue { background: #BBDEFB; color: #1565C0; }
        .section-header.green { background: #C8E6C9; color: #2E7D32; }
        .section-header.purple { background: #E1BEE7; color: #6A1B9A; }
        .section-header.yellow { background: #FFF9C4; color: #F57F17; }
        .section-content { padding: 15px; background: #fafafa; }
        
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-size: 12px; font-weight: 600; margin-bottom: 6px; color: #555; }
        .form-group input, .form-group select { padding: 12px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 16px; }
        
        .input-with-symbol { display: flex; align-items: center; background: white; border: 2px solid #e0e0e0; border-radius: 6px; padding: 0 12px; }
        .input-with-symbol input { border: none; flex: 1; padding: 12px 0; text-align: right; font-size: 16px; }
        
        .big-card { background: linear-gradient(135deg, var(--c1), var(--c2)); color: white; padding: 30px; text-align: center; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .big-card .label { font-size: 16px; font-weight: 700; margin-bottom: 12px; text-transform: uppercase; }
        .big-card .value { font-size: 40px; font-weight: 900; line-height: 1.2; }
        
        .add-btn { background: #2196F3; color: white; font-weight: 700; padding: 18px 35px; border-radius: 50px; border: none; font-size: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; margin: 20px auto; }
        
        .tier-results { background: white; padding: 12px; border-radius: 6px; border: 2px solid #e0e0e0; margin-top: 10px; }
        .tier-info { text-align: center; font-size: 11px; font-weight: 600; padding: 8px; background: #f5f5f5; border-radius: 4px; margin-bottom: 10px; }
        .tier-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
        .tier-person { border: 2px solid #e0e0e0; border-radius: 6px; padding: 12px; }
        .tier-box { text-align: center; padding: 10px; border-radius: 4px; margin-bottom: 6px; }
        .tier-box.light { background: #f5f5f5; border: 1px solid #ddd; }
        .tier-box.bold { background: #e8f5e9; border: 2px solid #4CAF50; }
        .tier-box.purple-light { background: #f3e5f5; border: 1px solid #ddd; }
        .tier-box.purple-bold { background: #f3e5f5; border: 2px solid #9C27B0; }
        .tier-box .tier-label { font-size: 10px; font-weight: 600; margin-bottom: 4px; }
        .tier-box .tier-value { font-size: 18px; font-weight: 700; }
        
        .calc-display { background: #f0f0f0; padding: 8px; border-radius: 4px; text-align: center; font-weight: 600; margin-top: 5px; }
        
        .bottom-totals { 
            background: linear-gradient(135deg, #1976D2, #0D47A1); 
            border: 4px solid #0D47A1; 
            border-radius: 12px; 
            padding: 25px; 
            margin-top: 25px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }
        .bottom-totals h3 { 
            color: white; 
            text-align: center; 
            font-size: 18px; 
            margin-bottom: 20px; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .divider {
            height: 4px;
            background: linear-gradient(to right, #2196F3, #4CAF50, #9C27B0);
            margin: 30px 0;
            border-radius: 2px;
        }
        
        @media print {
            .no-print { display: none !important; }
            .print-view { display: block !important; }
            .sticky-header { position: relative !important; }
        }
        .print-view { display: none; }
        
        @media (max-width: 768px) {
            .bank-info {
                grid-template-columns: 1fr;
            }
            .summary-section-invoice {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainView" class="no-print">
            <div class="sticky-header">
                <div class="header">
                    <h1>ALTA CAL - INVOICE & PROFIT SYSTEM</h1>
                    <div class="header-buttons">
                        <button class="btn btn-primary" onclick="app.showSaveDialog()">üíæ SAVE</button>
                        <button class="btn btn-blue" onclick="app.showPrintReport()">üñ®Ô∏è PRINT REPORT</button>
                    </div>
                </div>
                
                <div class="week-input">
                    <label style="display: block; font-weight: 700; margin-bottom: 10px;">COLLECTION WEEK PERIOD</label>
                    <input type="text" id="collectionWeek" placeholder="10/1-10/6">
                </div>
                
                <div id="summaryCards" class="summary-cards"></div>
            </div>
            
            <div class="scrollable-content">
                <!-- INVOICE SHEET -->
                <div class="invoice-sheet">
                    <div class="invoice-header">üìã INVOICE SHEET</div>
                    
                    <div class="invoice-section">
                        <div class="invoice-section-header" style="display: grid; grid-template-columns: auto 1fr; gap: 20px; align-items: center;">
                            <div>JOB NUMBER: <input type="text" id="invoiceJobNumber" value="" placeholder="Enter job number" oninput="app.syncJobNumber(this.value)" style="background: white; border: 1px solid #666; padding: 5px 10px; font-size: 16px; font-weight: bold; color: #000; border-radius: 3px;"></div>
                            <div>MONEY IN BANK</div>
                        </div>
                        <div class="bank-info">
                            <div class="checkbox-container">
                                <input type="checkbox" id="moneyInBank">
                                <label for="moneyInBank">YES</label>
                            </div>
                            <div>
                                <input type="date" id="contractDate" value="">
                            </div>
                            <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;">
                                <div style="font-weight: bold;">CONTRACT AMOUNT</div>
                                <input type="number" class="amount-display" id="invoiceContractAmount" value="" placeholder="0.00" step="0.01" inputmode="decimal" oninput="app.syncContractAmount(this.value)" style="border: 1px solid #999;">
                            </div>
                        </div>
                    </div>

                    <div class="invoice-section">
                        <div class="invoice-section-header">INVOICE AMOUNT</div>
                        <table class="invoice-table">
                            <thead>
                                <tr>
                                    <th style="width: 50%;">LABOR & MATERIAL</th>
                                    <th style="width: 35%;">COST</th>
                                    <th style="width: 15%;">PAID</th>
                                </tr>
                            </thead>
                            <tbody id="invoiceTableBody">
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                                <tr>
                                    <td><input type="text" placeholder="Company name"></td>
                                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                                    <td style="text-align: center;"><input type="checkbox"></td>
                                </tr>
                            </tbody>
                        </table>
                        <button onclick="app.addInvoiceRow()" class="no-print" style="margin-top: 10px; padding: 10px 20px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%;">+ Add Invoice Row</button>
                    </div>

                    <div class="invoice-section">
                        <div class="summary-section-invoice">
                            <div class="summary-item-invoice">
                                <div class="summary-label-invoice">LABOR & MATERIAL COST</div>
                                <div class="summary-value-invoice" id="invoiceTotalCost"></div>
                            </div>
                            <div class="summary-item-invoice">
                                <div class="summary-label-invoice">JOB COST PERCENTAGE</div>
                                <div class="summary-value-invoice" id="invoiceCostPercentage"></div>
                            </div>
                        </div>
                    </div>

                    <button onclick="window.print()" class="no-print" style="margin-top: 15px; padding: 12px 24px; background-color: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; width: 100%; font-weight: 700;">üñ®Ô∏è Print Invoice Sheet</button>
                </div>
                
                <div class="divider"></div>
                
                <!-- PROFIT CALCULATORS -->
                <div id="calculators"></div>
                
                <div style="text-align: center;" class="no-print">
                    <button class="add-btn" onclick="app.addCalculator()">
                        <span style="font-size: 24px;">+</span> ADD NEW FILE
                    </button>
                </div>
            </div>
        </div>
        
        <div id="printView" class="print-view"></div>
    </div>

    <script>
        const app = {
            calculators: [],
            nextId: 1,
            
            init() {
                this.addCalculator();
                this.updateSummary();
            },
            
            fmt(value) {
                return '$' + parseFloat(value || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            },
            
            parseValue(value) {
                if (!value || value === '') return 0;
                const parsed = parseFloat(value.toString().replace(/[,$]/g, ''));
                return isNaN(parsed) ? 0 : parsed;
            },
            
            parseFee(amount, fee) {
                if (!fee || fee === '') return 0;
                const amountVal = this.parseValue(amount);
                const feeStr = fee.toString().trim();
                const percent = parseFloat(feeStr.replace('%', '')) || 0;
                return Math.round((amountVal * percent / 100) * 100) / 100;
            },
            
            // Invoice Sheet Functions
            syncJobNumber(value) {
                if (this.calculators.length > 0) {
                    this.calculators[0].jobNumber = value;
                    this.renderAll();
                }
            },
            
            syncContractAmount(value) {
                if (this.calculators.length > 0) {
                    this.calculators[0].contractAmount = value;
                    this.updateDisplaysOnly(this.calculators[0].id);
                    this.updateSummary();
                }
            },
            
            syncLaborMaterial(value) {
                if (this.calculators.length > 0) {
                    this.calculators[0].laborMaterial = value;
                    this.updateDisplaysOnly(this.calculators[0].id);
                    this.updateSummary();
                }
            },
            
            addInvoiceRow() {
                const tbody = document.getElementById('invoiceTableBody');
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td><input type="text" placeholder="Company name"></td>
                    <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                    <td style="text-align: center;"><input type="checkbox"></td>
                `;
                tbody.appendChild(newRow);
            },
            
            calculateInvoiceTotals() {
                const contractAmount = this.parseValue(document.getElementById('invoiceContractAmount').value);
                const amountInputs = document.querySelectorAll('.invoice-amount');
                let totalCost = 0;

                amountInputs.forEach(input => {
                    const value = this.parseValue(input.value);
                    totalCost += value;
                });

                // Update invoice sheet display
                if (totalCost > 0) {
                    document.getElementById('invoiceTotalCost').textContent = this.fmt(totalCost);
                } else {
                    document.getElementById('invoiceTotalCost').textContent = '';
                }
                
                if (contractAmount > 0 && totalCost > 0) {
                    const percentage = (totalCost / contractAmount * 100).toFixed(1);
                    document.getElementById('invoiceCostPercentage').textContent = percentage + '%';
                } else {
                    document.getElementById('invoiceCostPercentage').textContent = '';
                }

                // Sync to first calculator
                this.syncLaborMaterial(totalCost);
            },
            
            calculateOne(data) {
                const contractAmount = this.parseValue(data.contractAmount);
                const laborMaterial = this.parseValue(data.laborMaterial);
                const houseFeePercent = this.parseValue(data.houseFeePercent);
                const houseFeeAmount = (contractAmount * houseFeePercent) / 100;
                const dealerFeeAmount = this.parseFee(data.financeAmount, data.dealerFee);
                const creditCardFeeAmount = this.parseFee(data.creditCard, data.creditCardFee);
                
                const afterHouseFee = contractAmount - houseFeeAmount;
                const totalAfterFees = afterHouseFee - laborMaterial - dealerFeeAmount;
                const percentOfContract = afterHouseFee > 0 ? (totalAfterFees / afterHouseFee) * 100 : 0;
                
                let vetRate = 25;
                if (percentOfContract >= 50) vetRate = 55;
                else if (percentOfContract >= 40) vetRate = 45;
                else if (percentOfContract >= 33) vetRate = 35;
                
                let repRate = 20;
                if (percentOfContract >= 50) repRate = 40;
                else if (percentOfContract >= 40) repRate = 30;
                else if (percentOfContract >= 33) repRate = 25;
                
                const vetsCount = this.parseValue(data.numVets);
                const repsCount = this.parseValue(data.numReps);
                const totalPeople = vetsCount + repsCount;
                
                const vetCommissionTotal = (totalAfterFees * vetRate) / 100;
                const repCommissionTotal = (totalAfterFees * repRate) / 100;
                
                const perVetPayout = totalPeople > 0 ? (vetCommissionTotal / totalPeople) : 0;
                const perRepPayout = totalPeople > 0 ? (repCommissionTotal / totalPeople) : 0;
                
                const rideAlongFeeAmount = this.parseValue(data.rideAlong);
                const rideAlongFeePerPerson = totalPeople > 0 ? rideAlongFeeAmount / totalPeople : 0;
                const creditCardFeePerPerson = totalPeople > 0 ? creditCardFeeAmount / totalPeople : 0;
                
                const finalPerVetPayout = perVetPayout - rideAlongFeePerPerson - creditCardFeePerPerson;
                const finalPerRepPayout = perRepPayout - rideAlongFeePerPerson - creditCardFeePerPerson;
                const finalTotalVetsPayout = finalPerVetPayout * vetsCount;
                const finalTotalRepsPayout = finalPerRepPayout * repsCount;
                
                const rideAlongBonusAmount = this.parseValue(data.rideAlongBonus);
                const totalRideAlongPayout = rideAlongFeeAmount + rideAlongBonusAmount;
                
                const altaCalTotalPayout = laborMaterial + finalTotalVetsPayout + finalTotalRepsPayout + totalRideAlongPayout;
                const preliminaryProfit = afterHouseFee - altaCalTotalPayout - dealerFeeAmount;
                
                const canvasserPayout = preliminaryProfit * (this.parseValue(data.canvasserPercent) / 100);
                const confirmerPayout = contractAmount * (this.parseValue(data.confirmerPercent) / 100);
                const elisoPayout = contractAmount * (this.parseValue(data.elisoPercent) / 100);
                const prodMSPayout = this.parseValue(data.prodMSAmount) * (this.parseValue(data.prodMSPercent) / 100);
                const prodRSPayout = this.parseValue(data.prodRSAmount) * (this.parseValue(data.prodRSPercent) / 100);
                const prodNCPayout = this.parseValue(data.prodNCAmount) * (this.parseValue(data.prodNCPercent) / 100);
                const prodABEPayout = this.parseValue(data.prodABEAmount) * (this.parseValue(data.prodABEPercent) / 100);
                
                const additionalTeamPayout = canvasserPayout + confirmerPayout + elisoPayout + prodMSPayout + prodRSPayout + prodNCPayout + prodABEPayout;
                const totalTeamPayout = altaCalTotalPayout + additionalTeamPayout;
                const finalProfit = preliminaryProfit - additionalTeamPayout;
                const profitPercent = (afterHouseFee - dealerFeeAmount) > 0 ? (finalProfit / (afterHouseFee - dealerFeeAmount)) * 100 : 0;
                
                return {
                    contractAmount, houseFeeAmount, dealerFeeAmount, creditCardFeeAmount, afterHouseFee,
                    totalAfterFees, percentOfContract, vetRate, repRate, finalPerVetPayout, finalPerRepPayout,
                    finalTotalVetsPayout, finalTotalRepsPayout, totalRideAlongPayout, altaCalTotalPayout,
                    preliminaryProfit, canvasserPayout, confirmerPayout, elisoPayout, prodMSPayout, prodRSPayout,
                    prodNCPayout, prodABEPayout, additionalTeamPayout, totalTeamPayout, finalProfit, profitPercent,
                    vetsCount, repsCount, numRideAlongs: this.parseValue(data.numRideAlongs)
                };
            },
            
            addCalculator() {
                const calc = {
                    id: this.nextId++,
                    customerName: '', jobNumber: '', contractAmount: '', cashCheck: '', financeAmount: '',
                    dealerFee: '', creditCard: '', creditCardFee: '', houseFeePercent: '', laborMaterial: '',
                    numVets: '', numReps: '', rideAlong: '', rideAlongBonus: '', numRideAlongs: '',
                    canvasserPercent: '2', confirmerPercent: '0.25', elisoPercent: '1.5',
                    prodMSPercent: '0.25', prodMSAmount: '', prodRSPercent: '0.25', prodRSAmount: '',
                    prodNCPercent: '0.25', prodNCAmount: '', prodABEPercent: '0.25', prodABEAmount: '',
                    moneyThisWeek: '', financeSource: '', bankDropDay: ''
                };
                this.calculators.push(calc);
                this.renderAll();
            },
            
            deleteCalculator(id) {
                if (this.calculators.length <= 1) {
                    alert('Cannot delete the last calculator');
                    return;
                }
                if (confirm('Delete this calculator?')) {
                    this.calculators = this.calculators.filter(c => c.id !== id);
                    this.renderAll();
                }
            },
            
            updateField(id, field, value) {
                const calc = this.calculators.find(c => c.id === id);
                if (calc) {
                    calc[field] = value;
                    this.updateDisplaysOnly(id);
                    this.updateSummary();
                }
            },
            
            updateDisplaysOnly(calcId) {
                const calc = this.calculators.find(c => c.id === calcId);
                if (!calc) return;
                
                const data = this.calculateOne(calc);
                
                document.querySelectorAll(`[data-calc-id="${calcId}"]`).forEach(el => {
                    const field = el.getAttribute('data-field');
                    if (field && data[field] !== undefined) {
                        el.textContent = this.fmt(data[field]);
                    }
                });
                
                const tierSection = document.getElementById(`tier-section-${calcId}`);
                if (tierSection) {
                    if (data.vetsCount > 0 || data.repsCount > 0) {
                        tierSection.style.display = 'block';
                        
                        const tierInfo = document.getElementById(`tier-info-${calcId}`);
                        if (tierInfo) {
                            tierInfo.textContent = `Profit: ${data.percentOfContract.toFixed(1)}% ‚Üí Vet: ${data.vetRate}% | Rep: ${data.repRate}%`;
                        }
                        
                        const vetsBox = document.getElementById(`vets-box-${calcId}`);
                        if (vetsBox) {
                            if (data.vetsCount > 0) {
                                vetsBox.style.display = 'block';
                                vetsBox.innerHTML = `
                                    <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">VETS: ${data.vetsCount}</div>
                                    <div class="tier-box light">
                                        <div class="tier-label">Per Vet</div>
                                        <div class="tier-value" style="color: #2E7D32;">${this.fmt(data.finalPerVetPayout)}</div>
                                    </div>
                                    <div class="tier-box bold">
                                        <div class="tier-label">Total Vets</div>
                                        <div class="tier-value" style="color: #1B5E20;">${this.fmt(data.finalTotalVetsPayout)}</div>
                                    </div>
                                `;
                            } else {
                                vetsBox.style.display = 'none';
                            }
                        }
                        
                        const repsBox = document.getElementById(`reps-box-${calcId}`);
                        if (repsBox) {
                            if (data.repsCount > 0) {
                                repsBox.style.display = 'block';
                                repsBox.innerHTML = `
                                    <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">REPS: ${data.repsCount}</div>
                                    <div class="tier-box purple-light">
                                        <div class="tier-label">Per Rep</div>
                                        <div class="tier-value" style="color: #6A1B9A;">${this.fmt(data.finalPerRepPayout)}</div>
                                    </div>
                                    <div class="tier-box purple-bold">
                                        <div class="tier-label">Total Reps</div>
                                        <div class="tier-value" style="color: #4A148C;">${this.fmt(data.finalTotalRepsPayout)}</div>
                                    </div>
                                `;
                            } else {
                                repsBox.style.display = 'none';
                            }
                        }
                    } else {
                        tierSection.style.display = 'none';
                    }
                }
            },
            
            renderAll() {
                const container = document.getElementById('calculators');
                container.innerHTML = this.calculators.map((calc, index) => this.renderCalculator(calc, index)).join('');
                this.updateSummary();
            },
            
            renderCalculator(calc, index) {
                const data = this.calculateOne(calc);
                const deleteBtn = this.calculators.length > 1 ? `<button class="delete-btn no-print" onclick="app.deleteCalculator(${calc.id})">√ó</button>` : '';
                const showTiers = data.vetsCount > 0 || data.repsCount > 0;
                const isFirst = index === 0;
                
                return `
                    <div class="calculator">
                        ${deleteBtn}
                        <div class="calc-header">
                            <h2 style="font-size: 18px; font-weight: 700;">FILE #${index + 1}${isFirst ? ' (FROM INVOICE SHEET)' : ''}</h2>
                            <button class="btn btn-blue no-print" onclick="app.printSingle(${index})" style="padding: 10px 16px;">üñ®Ô∏è</button>
                        </div>
                        
                        <div class="calc-section">
                            <div class="form-grid" style="margin-bottom: 20px;">
                                <div class="form-group">
                                    <label>JOB NUMBER ${isFirst ? '(Auto-filled)' : ''}</label>
                                    <input type="text" value="${calc.jobNumber}" ${isFirst ? 'class="auto-filled" readonly' : 'oninput="app.updateField(' + calc.id + ', \'jobNumber\', this.value)"'}>
                                </div>
                                <div class="form-group">
                                    <label>CUSTOMER NAME</label>
                                    <input type="text" value="${calc.customerName}" oninput="app.updateField(${calc.id}, 'customerName', this.value)">
                                </div>
                            </div>
                            
                            <div class="section">
                                <div class="section-header blue">CONTRACT & PAYMENT</div>
                                <div class="section-content">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>CONTRACT AMOUNT ${isFirst ? '(Auto-filled)' : ''}</label>
                                            <div class="input-with-symbol ${isFirst ? 'auto-filled' : ''}">
                                                <span>$</span>
                                                <input type="number" step="0.01" value="${calc.contractAmount}" ${isFirst ? 'readonly' : 'oninput="app.updateField(' + calc.id + ', \'contractAmount\', this.value)"'}>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>CASH/CHECK</label>
                                            <div class="input-with-symbol">
                                                <span>$</span>
                                                <input type="number" step="0.01" value="${calc.cashCheck}" oninput="app.updateField(${calc.id}, 'cashCheck', this.value)">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>LABOR & MATERIAL ${isFirst ? '(Auto-filled)' : ''}</label>
                                            <div class="input-with-symbol ${isFirst ? 'auto-filled' : ''}">
                                                <span>$</span>
                                                <input type="number" step="0.01" value="${calc.laborMaterial}" ${isFirst ? 'readonly' : 'oninput="app.updateField(' + calc.id + ', \'laborMaterial\', this.value)"'}>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>FINANCE AMOUNT</label>
                                            <div class="input-with-symbol">
                                                <span>$</span>
                                                <input type="number" step="0.01" value="${calc.financeAmount}" oninput="app.updateField(${calc.id}, 'financeAmount', this.value)">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>DEALER FEE %</label>
                                            <input type="text" value="${calc.dealerFee}" placeholder="3.5" oninput="app.updateField(${calc.id}, 'dealerFee', this.value)">
                                            <div class="calc-display" data-calc-id="${calc.id}" data-field="dealerFeeAmount">${this.fmt(data.dealerFeeAmount)}</div>
                                        </div>
                                        <div class="form-group">
                                            <label>HOUSE FEE %</label>
                                            <div class="input-with-symbol">
                                                <input type="number" step="0.01" value="${calc.houseFeePercent}" oninput="app.updateField(${calc.id}, 'houseFeePercent', this.value)">
                                                <span>%</span>
                                            </div>
                                            <div class="calc-display" data-calc-id="${calc.id}" data-field="houseFeeAmount">${this.fmt(data.houseFeeAmount)}</div>
                                        </div>
                                        <div class="form-group">
                                            <label>CREDIT CARD</label>
                                            <div class="input-with-symbol">
                                                <span>$</span>
                                                <input type="number" step="0.01" value="${calc.creditCard}" oninput="app.updateField(${calc.id}, 'creditCard', this.value)">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>CC FEE %</label>
                                            <input type="number" step="0.01" value="${calc.creditCardFee}" placeholder="3.5" oninput="app.updateField(${calc.id}, 'creditCardFee', this.value)">
                                            <div class="calc-display" data-calc-id="${calc.id}" data-field="creditCardFeeAmount">${this.fmt(data.creditCardFeeAmount)}</div>
                                        </div>
                                        <div class="form-group">
                                            <label>AFTER HOUSE FEE</label>
                                            <div style="text-align: center; padding: 15px; background: #BBDEFB; border-radius: 6px; font-weight: 700; font-size: 18px;" data-calc-id="${calc.id}" data-field="afterHouseFee">
                                                ${this.fmt(data.afterHouseFee)}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <div class="section-header green">ALTA CAL TEAM (TIERED RATES)</div>
                                <div class="section-content">
                                    <div class="form-grid" style="margin-bottom: 15px;">
                                        <div class="form-group">
                                            <label>VETS ON CONTRACT</label>
                                            <input type="number" value="${calc.numVets}" oninput="app.updateField(${calc.id}, 'numVets', this.value)" style="text-align: center; font-size: 20px; font-weight: 700;">
                                        </div>
                                        <div class="form-group">
                                            <label>REPS ON CONTRACT</label>
                                            <input type="number" value="${calc.numReps}" oninput="app.updateField(${calc.id}, 'numReps', this.value)" style="text-align: center; font-size: 20px; font-weight: 700;">
                                        </div>
                                        <div class="form-group">
                                            <label>RIDE ALONGS</label>
                                            <input type="number" value="${calc.numRideAlongs}" oninput="app.updateField(${calc.id}, 'numRideAlongs', this.value)" style="text-align: center; font-size: 20px; font-weight: 700;">
                                        </div>
                                    </div>
                                    
                                    <div id="tier-section-${calc.id}" class="tier-results" style="display: ${showTiers ? 'block' : 'none'};">
                                        <div class="tier-info" id="tier-info-${calc.id}">
                                            Profit: ${data.percentOfContract.toFixed(1)}% ‚Üí Vet: ${data.vetRate}% | Rep: ${data.repRate}%
                                        </div>
                                        <div class="tier-grid">
                                            <div class="tier-person" id="vets-box-${calc.id}" style="display: ${data.vetsCount > 0 ? 'block' : 'none'};">
                                                <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">VETS: ${data.vetsCount}</div>
                                                <div class="tier-box light">
                                                    <div class="tier-label">Per Vet</div>
                                                    <div class="tier-value" style="color: #2E7D32;">${this.fmt(data.finalPerVetPayout)}</div>
                                                </div>
                                                <div class="tier-box bold">
                                                    <div class="tier-label">Total Vets</div>
                                                    <div class="tier-value" style="color: #1B5E20;">${this.fmt(data.finalTotalVetsPayout)}</div>
                                                </div>
                                            </div>
                                            <div class="tier-person" id="reps-box-${calc.id}" style="display: ${data.repsCount > 0 ? 'block' : 'none'};">
                                                <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">REPS: ${data.repsCount}</div>
                                                <div class="tier-box purple-light">
                                                    <div class="tier-label">Per Rep</div>
                                                    <div class="tier-value" style="color: #6A1B9A;">${this.fmt(data.finalPerRepPayout)}</div>
                                                </div>
                                                <div class="tier-box purple-bold">
                                                    <div class="tier-label">Total Reps</div>
                                                    <div class="tier-value" style="color: #4A148C;">${this.fmt(data.finalTotalRepsPayout)}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid" style="margin-top: 15px;">
                                        <div class="form-group">
                                            <label style="color: #D32F2F;">RIDE ALONG FEE</label>
                                            <div class="input-with-symbol" style="background: #FFEBEE; border-color: #EF5350;">
                                                <span>$</span>
                                                <input type="number" step="0.01" value="${calc.rideAlong}" oninput="app.updateField(${calc.id}, 'rideAlong', this.value)" style="background: transparent;">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label style="color: #D32F2F;">RIDE ALONG BONUS</label>
                                            <div class="input-with-symbol" style="background: #FFEBEE; border-color: #EF5350;">
                                                <span>$</span>
                                                <input type="number" step="0.01" value="${calc.rideAlongBonus}" oninput="app.updateField(${calc.id}, 'rideAlongBonus', this.value)" style="background: transparent;">
                                            </div>
                                        </div>
                                        ${data.numRideAlongs > 0 ? `
                                            <div class="form-group">
                                                <label>TOTAL RIDE ALONG PAYOUT</label>
                                                <div style="text-align: center; padding: 12px; background: #FFCDD2; border: 2px solid #EF5350; border-radius: 6px; font-weight: 700; font-size: 16px;" data-calc-id="${calc.id}" data-field="totalRideAlongPayout">
                                                    ${this.fmt(data.totalRideAlongPayout)}
                                                </div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <div class="section-header purple">ADDITIONAL TEAM</div>
                                <div class="section-content">
                                    <div style="text-align: center; padding: 12px; background: #E1BEE7; border: 2px solid #9C27B0; border-radius: 6px; font-weight: 700; margin-bottom: 12px;">
                                        <div style="font-size: 11px; margin-bottom: 4px;">ADDITIONAL TEAM TOTAL</div>
                                        <div style="font-size: 18px;" data-calc-id="${calc.id}" data-field="additionalTeamPayout">${this.fmt(data.additionalTeamPayout)}</div>
                                    </div>
                                    
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>CANVASSER %</label>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <input type="number" step="0.01" value="${calc.canvasserPercent}" oninput="app.updateField(${calc.id}, 'canvasserPercent', this.value)" style="width: 70px;">
                                                <span style="font-size: 13px;">% = <span data-calc-id="${calc.id}" data-field="canvasserPayout">${this.fmt(data.canvasserPayout)}</span></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>CONFIRMER %</label>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <input type="number" step="0.01" value="${calc.confirmerPercent}" oninput="app.updateField(${calc.id}, 'confirmerPercent', this.value)" style="width: 70px;">
                                                <span style="font-size: 13px;">% = <span data-calc-id="${calc.id}" data-field="confirmerPayout">${this.fmt(data.confirmerPayout)}</span></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>ELISO %</label>
                                            <div style="display: flex; gap: 8px; align-items: center;">
                                                <input type="number" step="0.01" value="${calc.elisoPercent}" oninput="app.updateField(${calc.id}, 'elisoPercent', this.value)" style="width: 70px;">
                                                <span style="font-size: 13px;">% = <span data-calc-id="${calc.id}" data-field="elisoPayout">${this.fmt(data.elisoPayout)}</span></span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-grid" style="margin-top: 12px;">
                                        <div class="form-group">
                                            <label>PROD MS</label>
                                            <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                                                <input type="number" step="0.01" value="${calc.prodMSPercent}" oninput="app.updateField(${calc.id}, 'prodMSPercent', this.value)" style="width: 50px;">
                                                <span>%</span>
                                                <input type="number" step="0.01" value="${calc.prodMSAmount}" oninput="app.updateField(${calc.id}, 'prodMSAmount', this.value)" style="width: 80px;">
                                                <span>= <span data-calc-id="${calc.id}" data-field="prodMSPayout">${this.fmt(data.prodMSPayout)}</span></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>PROD RS</label>
                                            <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                                                <input type="number" step="0.01" value="${calc.prodRSPercent}" oninput="app.updateField(${calc.id}, 'prodRSPercent', this.value)" style="width: 50px;">
                                                <span>%</span>
                                                <input type="number" step="0.01" value="${calc.prodRSAmount}" oninput="app.updateField(${calc.id}, 'prodRSAmount', this.value)" style="width: 80px;">
                                                <span>= <span data-calc-id="${calc.id}" data-field="prodRSPayout">${this.fmt(data.prodRSPayout)}</span></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>PROD NC</label>
                                            <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                                                <input type="number" step="0.01" value="${calc.prodNCPercent}" oninput="app.updateField(${calc.id}, 'prodNCPercent', this.value)" style="width: 50px;">
                                                <span>%</span>
                                                <input type="number" step="0.01" value="${calc.prodNCAmount}" oninput="app.updateField(${calc.id}, 'prodNCAmount', this.value)" style="width: 80px;">
                                                <span>= <span data-calc-id="${calc.id}" data-field="prodNCPayout">${this.fmt(data.prodNCPayout)}</span></span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>PROD ABE</label>
                                            <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                                                <input type="number" step="0.01" value="${calc.prodABEPercent}" oninput="app.updateField(${calc.id}, 'prodABEPercent', this.value)" style="width: 50px;">
                                                <span>%</span>
                                                <input type="number" step="0.01" value="${calc.prodABEAmount}" oninput="app.updateField(${calc.id}, 'prodABEAmount', this.value)" style="width: 80px;">
                                                <span>= <span data-calc-id="${calc.id}" data-field="prodABEPayout">${this.fmt(data.prodABEPayout)}</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="section">
                                <div class="section-header yellow">FINANCE & BANK</div>
                                <div class="section-content">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label>MONEY THIS WEEK</label>
                                            <div class="input-with-symbol">
                                                <span>$</span>
                                                <input type="number" step="0.01" value="${calc.moneyThisWeek}" oninput="app.updateField(${calc.id}, 'moneyThisWeek', this.value)">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label>FINANCE SOURCE</label>
                                            <select value="${calc.financeSource}" onchange="app.updateField(${calc.id}, 'financeSource', this.value)">
                                                <option value="">Select</option>
                                                <option value="Finance" ${calc.financeSource === 'Finance' ? 'selected' : ''}>Finance</option>
                                                <option value="Cash" ${calc.financeSource === 'Cash' ? 'selected' : ''}>Cash</option>
                                                <option value="Both" ${calc.financeSource === 'Both' ? 'selected' : ''}>Both</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label>BANK DROP DAY</label>
                                            <select value="${calc.bankDropDay}" onchange="app.updateField(${calc.id}, 'bankDropDay', this.value)">
                                                <option value="">Select Day</option>
                                                <option value="Monday" ${calc.bankDropDay === 'Monday' ? 'selected' : ''}>Monday</option>
                                                <option value="Tuesday" ${calc.bankDropDay === 'Tuesday' ? 'selected' : ''}>Tuesday</option>
                                                <option value="Wednesday" ${calc.bankDropDay === 'Wednesday' ? 'selected' : ''}>Wednesday</option>
                                                <option value="Thursday" ${calc.bankDropDay === 'Thursday' ? 'selected' : ''}>Thursday</option>
                                                <option value="Friday" ${calc.bankDropDay === 'Friday' ? 'selected' : ''}>Friday</option>
                                                <option value="Saturday" ${calc.bankDropDay === 'Saturday' ? 'selected' : ''}>Saturday</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bottom-totals">
                                <h3>üìä FILE #${index + 1} TOTALS</h3>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                    <div class="big-card blue">
                                        <div class="label">Total Payout</div>
                                        <div class="value" data-calc-id="${calc.id}" data-field="totalTeamPayout">${this.fmt(data.totalTeamPayout)}</div>
                                    </div>
                                    <div class="big-card purple">
                                        <div class="label">Total Profit</div>
                                        <div class="value" data-calc-id="${calc.id}" data-field="finalProfit">${this.fmt(data.finalProfit)}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            },
            
            updateSummary() {
                let totalPayout = 0, totalProfit = 0, totalMoney = 0, totalAfterHouse = 0;
                
                this.calculators.forEach(calc => {
                    const data = this.calculateOne(calc);
                    totalPayout += data.totalTeamPayout;
                    totalProfit += data.finalProfit;
                    totalMoney += this.parseValue(calc.moneyThisWeek);
                    totalAfterHouse += (data.afterHouseFee - data.dealerFeeAmount);
                });
                
                const profitPercent = totalAfterHouse > 0 ? (totalProfit / totalAfterHouse) * 100 : 0;
                
                document.getElementById('summaryCards').innerHTML = `
                    <div class="summary-card blue">
                        <div class="label">TOTAL PAYOUT</div>
                        <div class="value">${this.fmt(totalPayout)}</div>
                    </div>
                    <div class="summary-card purple">
                        <div class="label">TOTAL PROFIT</div>
                        <div class="value">${this.fmt(totalProfit)}</div>
                    </div>
                    <div class="summary-card green">
                        <div class="label">PROFIT %</div>
                        <div class="value">${profitPercent.toFixed(2)}%</div>
                    </div>
                    <div class="summary-card red">
                        <div class="label">MONEY THIS WEEK</div>
                        <div class="value">${this.fmt(totalMoney)}</div>
                    </div>
                `;
            },
            
            printSingle(index) {
                window.print();
            },
            
            showPrintReport() {
                window.print();
            },
            
            closePrint() {
                document.getElementById('mainView').style.display = 'block';
                document.getElementById('printView').style.display = 'none';
            },
            
            showSaveDialog() {
                const name = prompt('Enter report name:');
                if (name && name.trim()) {
                    const data = {
                        name: name.trim(),
                        date: new Date().toISOString(),
                        collectionWeek: document.getElementById('collectionWeek').value,
                        calculators: this.calculators,
                        invoiceData: {
                            jobNumber: document.getElementById('invoiceJobNumber').value,
                            contractAmount: document.getElementById('invoiceContractAmount').value,
                            contractDate: document.getElementById('contractDate').value
                        }
                    };
                    const key = 'report_' + Date.now();
                    localStorage.setItem(key, JSON.stringify(data));
                    alert('Report saved!');
                }
            }
        };
        
        window.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
