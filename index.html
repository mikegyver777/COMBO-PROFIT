<script>
/* --- ADD this helper inside the IIFE where app is defined --- */
function buildFilePrintHTML(app, calc, index) {
  const data = app.calculateOne(calc);
  const hdr = `
    <h2 style="margin:0 0 8px 0;color:#1976D2;">FILE #${index + 1}${index===0 ? ' (FROM INVOICE SHEET)' : ''}</h2>
    <div style="font-size:13px;color:#333;margin-bottom:16px;">
      <strong>Job #:</strong> ${app.escape(calc.jobNumber || '—')}
      &nbsp;•&nbsp; <strong>Customer:</strong> ${app.escape(calc.customerName || '—')}
      &nbsp;•&nbsp; <strong>Bank Drop Day:</strong> ${app.escape(calc.bankDropDay || '—')}
      &nbsp;•&nbsp; <strong>Finance Source:</strong> ${app.escape(calc.financeSource || '—')}
    </div>
  `;

  const money = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-bottom:16px;">
      <div style="border:2px solid #1976D2;border-radius:8px;padding:12px;background:#E3F2FD;">
        <div style="font-size:12px;font-weight:700;">Total Collected (After Fees)</div>
        <div style="font-size:20px;font-weight:900;">${app.fmt(data.totalAfterFees)}</div>
      </div>
      <div style="border:2px solid #4CAF50;border-radius:8px;padding:12px;background:#E8F5E9;">
        <div style="font-size:12px;font-weight:700;">Labor & Material</div>
        <div style="font-size:20px;font-weight:900;">${app.fmt(app.parseValue(calc.laborMaterial))}</div>
      </div>
      <div style="border:2px solid #9C27B0;border-radius:8px;padding:12px;background:#F3E5F5;">
        <div style="font-size:12px;font-weight:700;">Final Profit</div>
        <div style="font-size:20px;font-weight:900;">${app.fmt(data.finalProfit)}</div>
      </div>
    </div>
  `;

  const team = `
    <h3 style="margin:16px 0 8px 0;">Team Payouts</h3>
    <table style="width:100%;border-collapse:collapse;font-size:13px;">
      <thead>
        <tr style="background:#f0f0f0;">
          <th style="border:1px solid #333;padding:8px;text-align:left;">Role</th>
          <th style="border:1px solid #333;padding:8px;text-align:center;">Count</th>
          <th style="border:1px solid #333;padding:8px;text-align:right;">Per Person</th>
          <th style="border:1px solid #333;padding:8px;text-align:right;">Total</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="border:1px solid #333;padding:8px;">Vets</td>
          <td style="border:1px solid #333;padding:8px;text-align:center;">${data.vetsCount}</td>
          <td style="border:1px solid #333;padding:8px;text-align:right;">${app.fmt(data.finalPerVetPayout)}</td>
          <td style="border:1px solid #333;padding:8px;text-align:right;">${app.fmt(data.finalTotalVetsPayout)}</td>
        </tr>
        <tr>
          <td style="border:1px solid #333;padding:8px;">Reps</td>
          <td style="border:1px solid #333;padding:8px;text-align:center;">${data.repsCount}</td>
          <td style="border:1px solid #333;padding:8px;text-align:right;">${app.fmt(data.finalPerRepPayout)}</td>
          <td style="border:1px solid #333;padding:8px;text-align:right;">${app.fmt(data.finalTotalRepsPayout)}</td>
        </tr>
        <tr>
          <td style="border:1px solid #333;padding:8px;">Ride-Along</td>
          <td style="border:1px solid #333;padding:8px;text-align:center;">${app.parseValue(calc.numRideAlongs)}</td>
          <td style="border:1px solid #333;padding:8px;text-align:right;">—</td>
          <td style="border:1px solid #333;padding:8px;text-align:right;">${app.fmt(data.totalRideAlongPayout)}</td>
        </tr>
      </tbody>
    </table>
    <div style="font-size:12px;margin-top:8px;color:#333;">
      Vet Rate: ${data.vetRate}% &nbsp;•&nbsp; Rep Rate: ${data.repRate}% &nbsp;•&nbsp;
      Profit Basis: ${data.percentOfContract.toFixed(1)}%
    </div>
  `;

  const totals = `
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;margin-top:16px;">
      <div style="border:3px solid #1976D2;border-radius:10px;padding:16px;background:linear-gradient(135deg,#1976D2,#0D47A1);color:#fff;">
        <div style="font-weight:700;text-transform:uppercase;font-size:12px;margin-bottom:6px;">Total Team Payout</div>
        <div style="font-size:26px;font-weight:900;">${app.fmt(data.totalTeamPayout)}</div>
      </div>
      <div style="border:3px solid #9C27B0;border-radius:10px;padding:16px;background:linear-gradient(135deg,#9C27B0,#6A1B9A);color:#fff;">
        <div style="font-weight:700;text-transform:uppercase;font-size:12px;margin-bottom:6px;">Final Profit</div>
        <div style="font-size:26px;font-weight:900;">${app.fmt(data.finalProfit)}</div>
      </div>
    </div>
  `;

  return `
    <section style="page-break-inside:avoid;border:2px solid #ddd;border-radius:10px;padding:16px;margin-bottom:20px;">
      ${hdr}
      ${money}
      ${team}
      ${totals}
    </section>
  `;
}

/* --- REPLACE app.printSingle with this --- */
app.printSingle = function (index) {
  const calc = this.calculators[index];
  if (!calc) return;

  const header = `
    <h1 style="text-align:center;color:#2196F3;margin:0 0 16px 0;border-bottom:3px solid #2196F3;padding-bottom:12px;">
      FILE #${index + 1} – Payout Sheet
    </h1>
  `;

  const html = `
    <div style="padding:24px;font-family:Arial, sans-serif;">
      ${header}
      ${buildFilePrintHTML(this, calc, index)}
    </div>
  `;

  document.getElementById('printView').innerHTML = html;
  document.getElementById('mainView').style.display = 'none';
  document.getElementById('printView').style.display = 'block';

  setTimeout(() => {
    window.print();
    this.closePrint();
  }, 100);
};

/* --- REPLACE app.showPrintReport with this --- */
app.showPrintReport = function () {
  const week = document.getElementById('collectionWeek').value || '—';
  const header = `
    <h1 style="text-align:center;color:#2196F3;margin:0 0 8px 0;border-bottom:3px solid #2196F3;padding-bottom:12px;">
      Combined Report – Payout Sheets
    </h1>
    <div style="text-align:center;font-size:14px;margin-bottom:16px;">
      Collection Week: <strong>${this.escape(week)}</strong>
    </div>
  `;

  const sections = this.calculators
    .map((c, i) => buildFilePrintHTML(this, c, i))
    .join('');

  const html = `<div style="padding:24px;font-family:Arial, sans-serif;">${header}${sections}</div>`;

  document.getElementById('printView').innerHTML = html;
  document.getElementById('mainView').style.display = 'none';
  document.getElementById('printView').style.display = 'block';

  setTimeout(() => {
    window.print();
    this.closePrint();
  }, 100);
};

/* --- REPLACE app.closePrint with this (keeps your invoice print working too) --- */
app.closePrint = function () {
  document.getElementById('mainView').style.display = 'block';
  document.getElementById('printView').style.display = 'none';
  document.getElementById('printView').innerHTML = '';
};
</script>
