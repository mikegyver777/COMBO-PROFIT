<script>
    const app = {
        calculators: [],
        nextId: 1,
        
        init() {
            this.addCalculator();
            this.updateSummary();
        },
        
        fmt(value) {
            return '$' + parseFloat(value || 0).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        },
        
        parseValue(value) {
            if (!value || value === '') return 0;
            const parsed = parseFloat(value.toString().replace(/[,$]/g, ''));
            return isNaN(parsed) ? 0 : parsed;
        },
        
        parseFee(amount, fee) {
            if (!fee || fee === '') return 0;
            const amountVal = this.parseValue(amount);
            const feeStr = fee.toString().trim();
            const percent = parseFloat(feeStr.replace('%', '')) || 0;
            return Math.round((amountVal * percent / 100) * 100) / 100;
        },
        
        getHouseFeePercent(contractAmount) {
            const amount = this.parseValue(contractAmount);
            if (amount <= 20000) return 10;
            if (amount <= 30000) return 9;
            return 8;
        },
        
        syncJobNumber(value) {
            if (this.calculators.length > 0) {
                this.calculators[0].jobNumber = value;
                this.renderAll();
            }
        },
        
        syncContractAmount(value) {
            if (this.calculators.length > 0) {
                this.calculators[0].contractAmount = value;
                this.calculators[0].houseFeePercent = this.getHouseFeePercent(value);
                this.renderAll();
                this.updateSummary();
            }
        },
        
        syncLaborMaterial(value) {
            if (this.calculators.length > 0) {
                this.calculators[0].laborMaterial = value;
                this.renderAll();
                this.updateSummary();
            }
        },
        
        addInvoiceRow() {
            const tbody = document.getElementById('invoiceTableBody');
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td><input type="text" placeholder="Company name"></td>
                <td><input type="number" step="0.01" class="invoice-amount" inputmode="decimal" oninput="app.calculateInvoiceTotals()"></td>
                <td style="text-align: center;"><input type="checkbox"></td>
            `;
            tbody.appendChild(newRow);
        },
        
        calculateInvoiceTotals() {
            const contractAmount = this.parseValue(document.getElementById('invoiceContractAmount').value);
            const amountInputs = document.querySelectorAll('.invoice-amount');
            let totalCost = 0;

            amountInputs.forEach(input => {
                const value = this.parseValue(input.value);
                totalCost += value;
            });

            if (totalCost > 0) {
                document.getElementById('invoiceTotalCost').textContent = this.fmt(totalCost);
            } else {
                document.getElementById('invoiceTotalCost').textContent = '';
            }
            
            if (contractAmount > 0 && totalCost > 0) {
                const percentage = (totalCost / contractAmount * 100).toFixed(1);
                document.getElementById('invoiceCostPercentage').textContent = percentage + '%';
            } else {
                document.getElementById('invoiceCostPercentage').textContent = '';
            }

            this.syncLaborMaterial(totalCost);
        },
        
        printInvoiceSheet() {
            const jobNumber = document.getElementById('invoiceJobNumber').value || 'N/A';
            const contractAmount = document.getElementById('invoiceContractAmount').value || '0';
            const contractDate = document.getElementById('contractDate').value || 'Not Set';
            const moneyInBank = document.getElementById('moneyInBank').checked ? 'YES' : 'NO';
            
            // Get all invoice rows
            const rows = Array.from(document.querySelectorAll('#invoiceTableBody tr')).map(row => {
                const inputs = row.querySelectorAll('input');
                return {
                    company: inputs[0].value,
                    cost: inputs[1].value,
                    paid: inputs[2].checked
                };
            }).filter(row => row.company || row.cost);
            
            const totalCost = document.getElementById('invoiceTotalCost').textContent || '$0.00';
            const costPercentage = document.getElementById('invoiceCostPercentage').textContent || '0%';
            
            const html = `
                <div style="padding: 30px; font-family: Arial, sans-serif;">
                    <h1 style="text-align: center; color: #2196F3; margin-bottom: 30px; border-bottom: 3px solid #2196F3; padding-bottom: 15px;">üìã INVOICE SHEET</h1>
                    
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 25px; border: 2px solid #333;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
                            <div><strong>JOB NUMBER:</strong> ${jobNumber}</div>
                            <div><strong>CONTRACT DATE:</strong> ${contractDate}</div>
                            <div><strong>MONEY IN BANK:</strong> ${moneyInBank}</div>
                            <div><strong>CONTRACT AMOUNT:</strong> ${this.fmt(contractAmount)}</div>
                        </div>
                    </div>
                    
                    <h2 style="background: #000; color: white; padding: 12px; margin-bottom: 15px; font-size: 16px;">INVOICE AMOUNT</h2>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; font-size: 13px;">
                        <thead>
                            <tr style="background: #f0f0f0;">
                                <th style="border: 1px solid #333; padding: 10px; text-align: left;">LABOR & MATERIAL</th>
                                <th style="border: 1px solid #333; padding: 10px; text-align: right; width: 150px;">COST</th>
                                <th style="border: 1px solid #333; padding: 10px; text-align: center; width: 80px;">PAID</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(row => `
                                <tr>
                                    <td style="border: 1px solid #333; padding: 8px;">${row.company || '-'}</td>
                                    <td style="border: 1px solid #333; padding: 8px; text-align: right;">${row.cost ? this.fmt(row.cost) : '-'}</td>
                                    <td style="border: 1px solid #333; padding: 8px; text-align: center;">${row.paid ? '‚úì' : ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px;">
                        <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #333;">
                            <div style="font-weight: 700; font-size: 14px; margin-bottom: 10px;">LABOR & MATERIAL COST</div>
                            <div style="font-size: 28px; font-weight: 900;">${totalCost}</div>
                        </div>
                        <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; text-align: center; border: 2px solid #333;">
                            <div style="font-weight: 700; font-size: 14px; margin-bottom: 10px;">JOB COST PERCENTAGE</div>
                            <div style="font-size: 28px; font-weight: 900;">${costPercentage}</div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('printView').innerHTML = html;
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('printView').style.display = 'block';
            
            setTimeout(() => {
                window.print();
                this.closePrint();
            }, 100);
        },
        
        calculateOne(data) {
            const contractAmount = this.parseValue(data.contractAmount);
            const cashCheck = this.parseValue(data.cashCheck);
            const financeAmount = this.parseValue(data.financeAmount);
            const creditCard = this.parseValue(data.creditCard);
            const laborMaterial = this.parseValue(data.laborMaterial);
            
            const houseFeePercent = this.parseValue(data.houseFeePercent);
            const houseFeeAmount = (contractAmount * houseFeePercent) / 100;
            const dealerFeeAmount = this.parseFee(data.financeAmount, data.dealerFee);
            const creditCardFeeAmount = this.parseFee(data.creditCard, data.creditCardFee);
            
            const totalCollected = cashCheck + financeAmount + creditCard;
            const totalAfterFees = totalCollected - houseFeeAmount - dealerFeeAmount - creditCardFeeAmount;
            const afterFeesAndLabor = totalAfterFees - laborMaterial;
            const percentOfContract = totalAfterFees > 0 ? (afterFeesAndLabor / totalAfterFees) * 100 : 0;
            
            let vetRate = 25;
            if (percentOfContract >= 50) vetRate = 55;
            else if (percentOfContract >= 40) vetRate = 45;
            else if (percentOfContract >= 33) vetRate = 35;
            
            let repRate = 20;
            if (percentOfContract >= 50) repRate = 40;
            else if (percentOfContract >= 40) repRate = 30;
            else if (percentOfContract >= 33) repRate = 25;
            
            const vetsCount = this.parseValue(data.numVets);
            const repsCount = this.parseValue(data.numReps);
            const totalPeople = vetsCount + repsCount;
            
            const vetCommissionTotal = (afterFeesAndLabor * vetRate) / 100;
            const repCommissionTotal = (afterFeesAndLabor * repRate) / 100;
            
            const perVetPayout = totalPeople > 0 ? (vetCommissionTotal / totalPeople) : 0;
            const perRepPayout = totalPeople > 0 ? (repCommissionTotal / totalPeople) : 0;
            
            const rideAlongFeeAmount = this.parseValue(data.rideAlong);
            const rideAlongFeePerPerson = totalPeople > 0 ? rideAlongFeeAmount / totalPeople : 0;
            const creditCardFeePerPerson = totalPeople > 0 ? creditCardFeeAmount / totalPeople : 0;
            
            const finalPerVetPayout = perVetPayout - rideAlongFeePerPerson - creditCardFeePerPerson;
            const finalPerRepPayout = perRepPayout - rideAlongFeePerPerson - creditCardFeePerPerson;
            const finalTotalVetsPayout = finalPerVetPayout * vetsCount;
            const finalTotalRepsPayout = finalPerRepPayout * repsCount;
            
            const rideAlongBonusAmount = this.parseValue(data.rideAlongBonus);
            const totalRideAlongPayout = rideAlongFeeAmount + rideAlongBonusAmount;
            
            const altaCalTotalPayout = laborMaterial + finalTotalVetsPayout + finalTotalRepsPayout + totalRideAlongPayout;
            const preliminaryProfit = totalAfterFees - altaCalTotalPayout;
            
            const canvasserPayout = preliminaryProfit * (this.parseValue(data.canvasserPercent) / 100);
            const confirmerPayout = contractAmount * (this.parseValue(data.confirmerPercent) / 100);
            const elisoPayout = contractAmount * (this.parseValue(data.elisoPercent) / 100);
            const prodMSPayout = this.parseValue(data.prodMSAmount) * (this.parseValue(data.prodMSPercent) / 100);
            const prodRSPayout = this.parseValue(data.prodRSAmount) * (this.parseValue(data.prodRSPercent) / 100);
            const prodNCPayout = this.parseValue(data.prodNCAmount) * (this.parseValue(data.prodNCPercent) / 100);
            const prodABEPayout = this.parseValue(data.prodABEAmount) * (this.parseValue(data.prodABEPercent) / 100);
            
            const additionalTeamPayout = canvasserPayout + confirmerPayout + elisoPayout + prodMSPayout + prodRSPayout + prodNCPayout + prodABEPayout;
            const totalTeamPayout = altaCalTotalPayout + additionalTeamPayout;
            const finalProfit = preliminaryProfit - additionalTeamPayout;
            const profitPercent = totalAfterFees > 0 ? (finalProfit / totalAfterFees) * 100 : 0;
            
            return {
                contractAmount, houseFeeAmount, dealerFeeAmount, creditCardFeeAmount, totalAfterFees,
                afterFeesAndLabor, percentOfContract, vetRate, repRate, finalPerVetPayout, finalPerRepPayout,
                finalTotalVetsPayout, finalTotalRepsPayout, totalRideAlongPayout, altaCalTotalPayout,
                preliminaryProfit, canvasserPayout, confirmerPayout, elisoPayout, prodMSPayout, prodRSPayout,
                prodNCPayout, prodABEPayout, additionalTeamPayout, totalTeamPayout, finalProfit, profitPercent,
                vetsCount, repsCount, numRideAlongs: this.parseValue(data.numRideAlongs), totalCollected
            };
        },
        
        addCalculator() {
            const calc = {
                id: this.nextId++,
                customerName: '', jobNumber: '', contractAmount: '', cashCheck: '', financeAmount: '',
                dealerFee: '', creditCard: '', creditCardFee: '', houseFeePercent: '', laborMaterial: '',
                numVets: '', numReps: '', rideAlong: '', rideAlongBonus: '', numRideAlongs: '',
                canvasserPercent: '2', confirmerPercent: '0.25', elisoPercent: '1.5',
                prodMSPercent: '0.25', prodMSAmount: '', prodRSPercent: '0.25', prodRSAmount: '',
                prodNCPercent: '0.25', prodNCAmount: '', prodABEPercent: '0.25', prodABEAmount: '',
                moneyThisWeek: '', financeSource: '', bankDropDay: ''
            };
            this.calculators.push(calc);
            this.renderAll();
        },
        
        deleteCalculator(id) {
            if (this.calculators.length <= 1) {
                alert('Cannot delete the last calculator');
                return;
            }
            if (confirm('Delete this calculator?')) {
                this.calculators = this.calculators.filter(c => c.id !== id);
                this.renderAll();
            }
        },
        
        updateField(id, field, value) {
            const calc = this.calculators.find(c => c.id === id);
            if (calc) {
                calc[field] = value;
                
                if (field === 'contractAmount') {
                    calc.houseFeePercent = this.getHouseFeePercent(value);
                }
                
                this.updateDisplaysOnly(id);
                this.updateSummary();
            }
        },
        
        updateDisplaysOnly(calcId) {
            const calc = this.calculators.find(c => c.id === calcId);
            if (!calc) return;
            
            const data = this.calculateOne(calc);
            
            document.querySelectorAll(`[data-calc-id="${calcId}"]`).forEach(el => {
                const field = el.getAttribute('data-field');
                if (field && data[field] !== undefined) {
                    el.textContent = this.fmt(data[field]);
                }
            });
            
            const houseFeeInput = document.querySelector(`input[data-calc-id="${calcId}"][data-field="houseFeePercent"]`);
            if (houseFeeInput) {
                houseFeeInput.value = calc.houseFeePercent;
            }
            
            const tierSection = document.getElementById(`tier-section-${calcId}`);
            if (tierSection) {
                if (data.vetsCount > 0 || data.repsCount > 0) {
                    tierSection.style.display = 'block';
                    
                    const tierInfo = document.getElementById(`tier-info-${calcId}`);
                    if (tierInfo) {
                        tierInfo.textContent = `Profit: ${data.percentOfContract.toFixed(1)}% ‚Üí Vet: ${data.vetRate}% | Rep: ${data.repRate}%`;
                    }
                    
                    const vetsBox = document.getElementById(`vets-box-${calcId}`);
                    if (vetsBox) {
                        if (data.vetsCount > 0) {
                            vetsBox.style.display = 'block';
                            vetsBox.innerHTML = `
                                <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">VETS: ${data.vetsCount}</div>
                                <div class="tier-box light">
                                    <div class="tier-label">Per Vet</div>
                                    <div class="tier-value" style="color: #2E7D32;">${this.fmt(data.finalPerVetPayout)}</div>
                                </div>
                                <div class="tier-box bold">
                                    <div class="tier-label">Total Vets</div>
                                    <div class="tier-value" style="color: #1B5E20;">${this.fmt(data.finalTotalVetsPayout)}</div>
                                </div>
                            `;
                        } else {
                            vetsBox.style.display = 'none';
                        }
                    }
                    
                    const repsBox = document.getElementById(`reps-box-${calcId}`);
                    if (repsBox) {
                        if (data.repsCount > 0) {
                            repsBox.style.display = 'block';
                            repsBox.innerHTML = `
                                <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">REPS: ${data.repsCount}</div>
                                <div class="tier-box purple-light">
                                    <div class="tier-label">Per Rep</div>
                                    <div class="tier-value" style="color: #6A1B9A;">${this.fmt(data.finalPerRepPayout)}</div>
                                </div>
                                <div class="tier-box purple-bold">
                                    <div class="tier-label">Total Reps</div>
                                    <div class="tier-value" style="color: #4A148C;">${this.fmt(data.finalTotalRepsPayout)}</div>
                                </div>
                            `;
                        } else {
                            repsBox.style.display = 'none';
                        }
                    }
                } else {
                    tierSection.style.display = 'none';
                }
            }
        },
        
        renderAll() {
            const container = document.getElementById('calculators');
            container.innerHTML = this.calculators.map((calc, index) => this.renderCalculator(calc, index)).join('');
            this.updateSummary();
        },
        
        renderCalculator(calc, index) {
            const data = this.calculateOne(calc);
            const deleteBtn = this.calculators.length > 1 ? `<button class="delete-btn no-print" onclick="app.deleteCalculator(${calc.id})">√ó</button>` : '';
            const showTiers = data.vetsCount > 0 || data.repsCount > 0;
            const isFirst = index === 0;
            
            return `
                <div class="calculator">
                    ${deleteBtn}
                    <div class="calc-header">
                        <h2 style="font-size: 18px; font-weight: 700;">FILE #${index + 1}${isFirst ? ' (FROM INVOICE SHEET)' : ''}</h2>
                        <button class="btn btn-blue no-print" onclick="app.printSingle(${index})" style="padding: 10px 16px;">üñ®Ô∏è</button>
                    </div>
                    
                    <div class="calc-section">
                        <div class="form-grid" style="margin-bottom: 20px;">
                            <div class="form-group">
                                <label>JOB NUMBER ${isFirst ? '(Auto-filled)' : ''}</label>
                                <input type="text" value="${calc.jobNumber}" ${isFirst ? 'class="auto-filled" readonly' : 'oninput="app.updateField(' + calc.id + ', \'jobNumber\', this.value)"'}>
                            </div>
                            <div class="form-group">
                                <label>CUSTOMER NAME</label>
                                <input type="text" value="${calc.customerName}" oninput="app.updateField(${calc.id}, 'customerName', this.value)">
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-header blue">CONTRACT & PAYMENT</div>
                            <div class="section-content">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>CONTRACT AMOUNT ${isFirst ? '(Auto-filled)' : ''}</label>
                                        <div class="input-with-symbol ${isFirst ? 'auto-filled' : ''}">
                                            <span>$</span>
                                            <input type="number" step="0.01" value="${calc.contractAmount}" ${isFirst ? 'readonly' : 'oninput="app.updateField(' + calc.id + ', \'contractAmount\', this.value)"'}>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>CASH/CHECK</label>
                                        <div class="input-with-symbol">
                                            <span>$</span>
                                            <input type="number" step="0.01" value="${calc.cashCheck}" oninput="app.updateField(${calc.id}, 'cashCheck', this.value)">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>LABOR & MATERIAL ${isFirst ? '(Auto-filled)' : ''}</label>
                                        <div class="input-with-symbol ${isFirst ? 'auto-filled' : ''}">
                                            <span>$</span>
                                            <input type="number" step="0.01" value="${calc.laborMaterial}" ${isFirst ? 'readonly' : 'oninput="app.updateField(' + calc.id + ', \'laborMaterial\', this.value)"'}>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>FINANCE AMOUNT</label>
                                        <div class="input-with-symbol">
                                            <span>$</span>
                                            <input type="number" step="0.01" value="${calc.financeAmount}" oninput="app.updateField(${calc.id}, 'financeAmount', this.value)">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>DEALER FEE %</label>
                                        <input type="text" value="${calc.dealerFee}" placeholder="3.5" oninput="app.updateField(${calc.id}, 'dealerFee', this.value)">
                                        <div class="calc-display" data-calc-id="${calc.id}" data-field="dealerFeeAmount">${this.fmt(data.dealerFeeAmount)}</div>
                                    </div>
                                    <div class="form-group">
                                        <label>HOUSE FEE % (Auto)</label>
                                        <div class="input-with-symbol auto-filled">
                                            <input type="number" step="0.01" value="${calc.houseFeePercent}" data-calc-id="${calc.id}" data-field="houseFeePercent" readonly>
                                            <span>%</span>
                                        </div>
                                        <div class="calc-display" data-calc-id="${calc.id}" data-field="houseFeeAmount">${this.fmt(data.houseFeeAmount)}</div>
                                    </div>
                                    <div class="form-group">
                                        <label>CREDIT CARD</label>
                                        <div class="input-with-symbol">
                                            <span>$</span>
                                            <input type="number" step="0.01" value="${calc.creditCard}" oninput="app.updateField(${calc.id}, 'creditCard', this.value)">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>CC FEE %</label>
                                        <input type="number" step="0.01" value="${calc.creditCardFee}" placeholder="3.5" oninput="app.updateField(${calc.id}, 'creditCardFee', this.value)">
                                        <div class="calc-display" data-calc-id="${calc.id}" data-field="creditCardFeeAmount">${this.fmt(data.creditCardFeeAmount)}</div>
                                    </div>
                                    <div class="form-group">
                                        <label>TOTAL AFTER FEES</label>
                                        <div style="text-align: center; padding: 15px; background: #BBDEFB; border-radius: 6px; font-weight: 700; font-size: 18px;" data-calc-id="${calc.id}" data-field="totalAfterFees">
                                            ${this.fmt(data.totalAfterFees)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-header green">ALTA CAL TEAM (TIERED RATES)</div>
                            <div class="section-content">
                                <div class="form-grid" style="margin-bottom: 15px;">
                                    <div class="form-group">
                                        <label>VETS ON CONTRACT</label>
                                        <input type="number" value="${calc.numVets}" oninput="app.updateField(${calc.id}, 'numVets', this.value)" style="text-align: center; font-size: 20px; font-weight: 700;">
                                    </div>
                                    <div class="form-group">
                                        <label>REPS ON CONTRACT</label>
                                        <input type="number" value="${calc.numReps}" oninput="app.updateField(${calc.id}, 'numReps', this.value)" style="text-align: center; font-size: 20px; font-weight: 700;">
                                    </div>
                                    <div class="form-group">
                                        <label>RIDE ALONGS</label>
                                        <input type="number" value="${calc.numRideAlongs}" oninput="app.updateField(${calc.id}, 'numRideAlongs', this.value)" style="text-align: center; font-size: 20px; font-weight: 700;">
                                    </div>
                                </div>
                                
                                <div id="tier-section-${calc.id}" class="tier-results" style="display: ${showTiers ? 'block' : 'none'};">
                                    <div class="tier-info" id="tier-info-${calc.id}">
                                        Profit: ${data.percentOfContract.toFixed(1)}% ‚Üí Vet: ${data.vetRate}% | Rep: ${data.repRate}%
                                    </div>
                                    <div class="tier-grid">
                                        <div class="tier-person" id="vets-box-${calc.id}" style="display: ${data.vetsCount > 0 ? 'block' : 'none'};">
                                            <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">VETS: ${data.vetsCount}</div>
                                            <div class="tier-box light">
                                                <div class="tier-label">Per Vet</div>
                                                <div class="tier-value" style="color: #2E7D32;">${this.fmt(data.finalPerVetPayout)}</div>
                                            </div>
                                            <div class="tier-box bold">
                                                <div class="tier-label">Total Vets</div>
                                                <div class="tier-value" style="color: #1B5E20;">${this.fmt(data.finalTotalVetsPayout)}</div>
                                            </div>
                                        </div>
                                        <div class="tier-person" id="reps-box-${calc.id}" style="display: ${data.repsCount > 0 ? 'block' : 'none'};">
                                            <div style="font-weight: 700; text-align: center; margin-bottom: 8px;">REPS: ${data.repsCount}</div>
                                            <div class="tier-box purple-light">
                                                <div class="tier-label">Per Rep</div>
                                                <div class="tier-value" style="color: #6A1B9A;">${this.fmt(data.finalPerRepPayout)}</div>
                                            </div>
                                            <div class="tier-box purple-bold">
                                                <div class="tier-label">Total Reps</div>
                                                <div class="tier-value" style="color: #4A148C;">${this.fmt(data.finalTotalRepsPayout)}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-grid" style="margin-top: 15px;">
                                    <div class="form-group">
                                        <label style="color: #D32F2F;">RIDE ALONG FEE</label>
                                        <div class="input-with-symbol" style="background: #FFEBEE; border-color: #EF5350;">
                                            <span>$</span>
                                            <input type="number" step="0.01" value="${calc.rideAlong}" oninput="app.updateField(${calc.id}, 'rideAlong', this.value)" style="background: transparent;">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label style="color: #D32F2F;">RIDE ALONG BONUS</label>
                                        <div class="input-with-symbol" style="background: #FFEBEE; border-color: #EF5350;">
                                            <span>$</span>
                                            <input type="number" step="0.01" value="${calc.rideAlongBonus}" oninput="app.updateField(${calc.id}, 'rideAlongBonus', this.value)" style="background: transparent;">
                                        </div>
                                    </div>
                                    ${data.numRideAlongs > 0 ? `
                                        <div class="form-group">
                                            <label>TOTAL RIDE ALONG PAYOUT</label>
                                            <div style="text-align: center; padding: 12px; background: #FFCDD2; border: 2px solid #EF5350; border-radius: 6px; font-weight: 700; font-size: 16px;" data-calc-id="${calc.id}" data-field="totalRideAlongPayout">
                                                ${this.fmt(data.totalRideAlongPayout)}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-header purple">ADDITIONAL TEAM</div>
                            <div class="section-content">
                                <div style="text-align: center; padding: 12px; background: #E1BEE7; border: 2px solid #9C27B0; border-radius: 6px; font-weight: 700; margin-bottom: 12px;">
                                    <div style="font-size: 11px; margin-bottom: 4px;">ADDITIONAL TEAM TOTAL</div>
                                    <div style="font-size: 18px;" data-calc-id="${calc.id}" data-field="additionalTeamPayout">${this.fmt(data.additionalTeamPayout)}</div>
                                </div>
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>CANVASSER %</label>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <input type="number" step="0.01" value="${calc.canvasserPercent}" oninput="app.updateField(${calc.id}, 'canvasserPercent', this.value)" style="width: 70px;">
                                            <span style="font-size: 13px;">% = <span data-calc-id="${calc.id}" data-field="canvasserPayout">${this.fmt(data.canvasserPayout)}</span></span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>CONFIRMER %</label>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <input type="number" step="0.01" value="${calc.confirmerPercent}" oninput="app.updateField(${calc.id}, 'confirmerPercent', this.value)" style="width: 70px;">
                                            <span style="font-size: 13px;">% = <span data-calc-id="${calc.id}" data-field="confirmerPayout">${this.fmt(data.confirmerPayout)}</span></span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>ELISO %</label>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <input type="number" step="0.01" value="${calc.elisoPercent}" oninput="app.updateField(${calc.id}, 'elisoPercent', this.value)" style="width: 70px;">
                                            <span style="font-size: 13px;">% = <span data-calc-id="${calc.id}" data-field="elisoPayout">${this.fmt(data.elisoPayout)}</span></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-grid" style="margin-top: 12px;">
                                    <div class="form-group">
                                        <label>PROD MS</label>
                                        <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                                            <input type="number" step="0.01" value="${calc.prodMSPercent}" oninput="app.updateField(${calc.id}, 'prodMSPercent', this.value)" style="width: 50px;">
                                            <span>%</span>
                                            <input type="number" step="0.01" value="${calc.prodMSAmount}" oninput="app.updateField(${calc.id}, 'prodMSAmount', this.value)" style="width: 80px;">
                                            <span>= <span data-calc-id="${calc.id}" data-field="prodMSPayout">${this.fmt(data.prodMSPayout)}</span></span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>PROD RS</label>
                                        <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                                            <input type="number" step="0.01" value="${calc.prodRSPercent}" oninput="app.updateField(${calc.id}, 'prodRSPercent', this.value)" style="width: 50px;">
                                            <span>%</span>
                                            <input type="number" step="0.01" value="${calc.prodRSAmount}" oninput="app.updateField(${calc.id}, 'prodRSAmount', this.value)" style="width: 80px;">
                                            <span>= <span data-calc-id="${calc.id}" data-field="prodRSPayout">${this.fmt(data.prodRSPayout)}</span></span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>PROD NC</label>
                                        <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                                            <input type="number" step="0.01" value="${calc.prodNCPercent}" oninput="app.updateField(${calc.id}, 'prodNCPercent', this.value)" style="width: 50px;">
                                            <span>%</span>
                                            <input type="number" step="0.01" value="${calc.prodNCAmount}" oninput="app.updateField(${calc.id}, 'prodNCAmount', this.value)" style="width: 80px;">
                                            <span>= <span data-calc-id="${calc.id}" data-field="prodNCPayout">${this.fmt(data.prodNCPayout)}</span></span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>PROD ABE</label>
                                        <div style="display: flex; gap: 6px; align-items: center; font-size: 13px;">
                                            <input type="number" step="0.01" value="${calc.prodABEPercent}" oninput="app.updateField(${calc.id}, 'prodABEPercent', this.value)" style="width: 50px;">
                                            <span>%</span>
                                            <input type="number" step="0.01" value="${calc.prodABEAmount}" oninput="app.updateField(${calc.id}, 'prodABEAmount', this.value)" style="width: 80px;">
                                            <span>= <span data-calc-id="${calc.id}" data-field="prodABEPayout">${this.fmt(data.prodABEPayout)}</span></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-header yellow">FINANCE & BANK</div>
                            <div class="section-content">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>MONEY THIS WEEK</label>
                                        <div class="input-with-symbol">
                                            <span>$</span>
                                            <input type="number" step="0.01" value="${calc.moneyThisWeek}" oninput="app.updateField(${calc.id}, 'moneyThisWeek', this.value)">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>FINANCE SOURCE</label>
                                        <select value="${calc.financeSource}" onchange="app.updateField(${calc.id}, 'financeSource', this.value)">
                                            <option value="">Select</option>
                                            <option value="Finance" ${calc.financeSource === 'Finance' ? 'selected' : ''}>Finance</option>
                                            <option value="Cash" ${calc.financeSource === 'Cash' ? 'selected' : ''}>Cash</option>
                                            <option value="Both" ${calc.financeSource === 'Both' ? 'selected' : ''}>Both</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>BANK DROP DAY</label>
                                        <select value="${calc.bankDropDay}" onchange="app.updateField(${calc.id}, 'bankDropDay', this.value)">
                                            <option value="">Select Day</option>
                                            <option value="Monday" ${calc.bankDropDay === 'Monday' ? 'selected' : ''}>Monday</option>
                                            <option value="Tuesday" ${calc.bankDropDay === 'Tuesday' ? 'selected' : ''}>Tuesday</option>
                                            <option value="Wednesday" ${calc.bankDropDay === 'Wednesday' ? 'selected' : ''}>Wednesday</option>
                                            <option value="Thursday" ${calc.bankDropDay === 'Thursday' ? 'selected' : ''}>Thursday</option>
                                            <option value="Friday" ${calc.bankDropDay === 'Friday' ? 'selected' : ''}>Friday</option>
                                            <option value="Saturday" ${calc.bankDropDay === 'Saturday' ? 'selected' : ''}>Saturday</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bottom-totals">
                            <h3>üìä FILE #${index + 1} TOTALS</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="big-card blue">
                                    <div class="label">Total Payout</div>
                                    <div class="value" data-calc-id="${calc.id}" data-field="totalTeamPayout">${this.fmt(data.totalTeamPayout)}</div>
                                </div>
                                <div class="big-card purple">
                                    <div class="label">Total Profit</div>
                                    <div class="value" data-calc-id="${calc.id}" data-field="finalProfit">${this.fmt(data.finalProfit)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        },
        
        updateSummary() {
            let totalPayout = 0, totalProfit = 0, totalMoney = 0, totalAfterFees = 0;
            
            this.calculators.forEach(calc => {
                const data = this.calculateOne(calc);
                totalPayout += data.totalTeamPayout;
                totalProfit += data.finalProfit;
                totalMoney += this.parseValue(calc.moneyThisWeek);
                totalAfterFees += data.totalAfterFees;
            });
            
            const profitPercent = totalAfterFees > 0 ? (totalProfit / totalAfterFees) * 100 : 0;
            
            document.getElementById('summaryCards').innerHTML = `
                <div class="summary-card blue">
                    <div class="label">TOTAL PAYOUT</div>
                    <div class="value">${this.fmt(totalPayout)}</div>
                </div>
                <div class="summary-card purple">
                    <div class="label">TOTAL PROFIT</div>
                    <div class="value">${this.fmt(totalProfit)}</div>
                </div>
                <div class="summary-card green">
                    <div class="label">PROFIT %</div>
                    <div class="value">${profitPercent.toFixed(2)}%</div>
                </div>
                <div class="summary-card red">
                    <div class="label">MONEY THIS WEEK</div>
                    <div class="value">${this.fmt(totalMoney)}</div>
                </div>
            `;
        },
        
        printSingle(index) {
            const calc = this.calculators[index];
            const data = this.calculateOne(calc);
            const week = document.getElementById('collectionWeek').value || 'Not Specified';
            const isFirst = index === 0;
            
            let html = `
                <div style="padding: 25px; font-family: Arial, sans-serif; page-break-after: always;">
                    <h1 style="text-align: center; color: #1976D2; margin-bottom: 15px; border-bottom: 3px solid #1976D2; padding-bottom: 10px;">FILE #${index + 1} DETAILED REPORT</h1>
                    <div style="text-align: center; margin-bottom: 20px; font-size: 13px;">
                        <strong>Customer:</strong> ${calc.customerName || 'N/A'} | <strong>Job #:</strong> ${calc.jobNumber || 'N/A'} | <strong>Week:</strong> ${week}
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                        <div style="background: #E3F2FD; padding: 15px; border-radius: 6px; text-align: center; border: 2px solid #2196F3;">
                            <div style="font-size: 12px; font-weight: 700; margin-bottom: 8px; color: #1976D2;">TOTAL PAYOUT</div>
                            <div style="font-size: 26px; font-weight: 900; color: #000;">${this.fmt(data.totalTeamPayout)}</div>
                        </div>
                        <div style="background: #F3E5F5; padding: 15px; border-radius: 6px; text-align: center; border: 2px solid #9C27B0;">
                            <div style="font-size: 12px; font-weight: 700; margin-bottom: 8px; color: #6A1B9A;">TOTAL PROFIT</div>
                            <div style="font-size: 26px; font-weight: 900; color: #000;">${this.fmt(data.finalProfit)}</div>
                        </div>
                    </div>
            `;
            
            // If this is File #1, include invoice details
            if (isFirst) {
                const jobNumber = document.getElementById('invoiceJobNumber').value || 'N/A';
                const invoiceContractAmount = document.getElementById('invoiceContractAmount').value || '0';
                const totalCost = document.getElementById('invoiceTotalCost').textContent || '$0.00';
                const costPercentage = document.getElementById('invoiceCostPercentage').textContent || '0%';
                
                html += `
                    <div style="background: #E8F5E9; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #4CAF50;">
                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #2E7D32; text-align: center;">üìã INVOICE SHEET DETAILS</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                            <div><strong>Job Number:</strong> ${jobNumber}</div>
                            <div><strong>Contract Amount:</strong> ${this.fmt(invoiceContractAmount)}</div>
                            <div><strong>Labor & Material:</strong> ${totalCost}</div>
                            <div><strong>Job Cost %:</strong> ${costPercentage}</div>
                        </div>
                    </div>
                `;
            }
            
            html += `
                    <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #333;">
                        <h3 style="margin-bottom: 10px; font-size: 14px; color: #1565C0;">üí∞ CONTRACT & PAYMENT</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px;">
                            <div><strong>Contract Amount:</strong> ${this.fmt(data.contractAmount)}</div>
                            <div><strong>Cash/Check:</strong> ${this.fmt(this.parseValue(calc.cashCheck))}</div>
                            <div><strong>Finance Amount:</strong> ${this.fmt(this.parseValue(calc.financeAmount))}</div>
                            <div><strong>Credit Card:</strong> ${this.fmt(this.parseValue(calc.creditCard))}</div>
                            <div><strong>House Fee (${calc.houseFeePercent}%):</strong> ${this.fmt(data.houseFeeAmount)}</div>
                            <div><strong>Dealer Fee:</strong> ${this.fmt(data.dealerFeeAmount)}</div>
                            <div><strong>CC Fee:</strong> ${this.fmt(data.creditCardFeeAmount)}</div>
                            <div><strong>Labor & Material:</strong> ${this.fmt(this.parseValue(calc.laborMaterial))}</div>
                            <div style="grid-column: 1/-1; background: #BBDEFB; padding: 8px; border-radius: 4px; text-align: center; font-weight: 700;">
                                <strong>Total After Fees:</strong> ${this.fmt(data.totalAfterFees)}
                            </div>
                        </div>
                    </div>
                    
                    ${data.vetsCount > 0 || data.repsCount > 0 ? `
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #333;">
                            <h3 style="margin-bottom: 10px; font-size: 14px; color: #2E7D32;">üë• ALTA CAL TEAM (TIERED RATES)</h3>
                            <div style="text-align: center; margin-bottom: 12px; padding: 8px; background: white; border-radius: 4px; font-size: 11px; font-weight: 700;">
                                Profit: ${data.percentOfContract.toFixed(1)}% ‚Üí Vet Rate: ${data.vetRate}% | Rep Rate: ${data.repRate}%
                            </div>
                            <div style="display: grid; grid-template-columns: ${data.vetsCount > 0 && data.repsCount > 0 ? '1fr 1fr' : '1fr'}; gap: 12px;">
                                ${data.vetsCount > 0 ? `
                                    <div style="border: 2px solid #4CAF50; padding: 10px; border-radius: 4px; background: #E8F5E9;">
                                        <div style="font-weight: 700; margin-bottom: 6px; font-size: 12px; text-align: center; color: #2E7D32;">VETS: ${data.vetsCount}</div>
                                        <div style="font-size: 11px;"><strong>Per Vet:</strong> ${this.fmt(data.finalPerVetPayout)}</div>
                                        <div style="font-size: 11px;"><strong>Ride Along Fee:</strong> -${this.fmt(this.parseValue(calc.rideAlong) / (data.vetsCount + data.repsCount))}</div>
                                        <div style="font-size: 11px;"><strong>CC Fee:</strong> -${this.fmt(data.creditCardFeeAmount / (data.vetsCount + data.repsCount))}</div>
                                        <div style="font-size: 12px; font-weight: 700; margin-top: 5px; padding-top: 5px; border-top: 1px solid #4CAF50;"><strong>Total Vets:</strong> ${this.fmt(data.finalTotalVetsPayout)}</div>
                                    </div>
                                ` : ''}
                                ${data.repsCount > 0 ? `
                                    <div style="border: 2px solid #9C27B0; padding: 10px; border-radius: 4px; background: #F3E5F5;">
                                        <div style="font-weight: 700; margin-bottom: 6px; font-size: 12px; text-align: center; color: #6A1B9A;">REPS: ${data.repsCount}</div>
                                        <div style="font-size: 11px;"><strong>Per Rep:</strong> ${this.fmt(data.finalPerRepPayout)}</div>
                                        <div style="font-size: 11px;"><strong>Ride Along Fee:</strong> -${this.fmt(this.parseValue(calc.rideAlong) / (data.vetsCount + data.repsCount))}</div>
                                        <div style="font-size: 11px;"><strong>CC Fee:</strong> -${this.fmt(data.creditCardFeeAmount / (data.vetsCount + data.repsCount))}</div>
                                        <div style="font-size: 12px; font-weight: 700; margin-top: 5px; padding-top: 5px; border-top: 1px solid #9C27B0;"><strong>Total Reps:</strong> ${this.fmt(data.finalTotalRepsPayout)}</div>
                                    </div>
                                ` : ''}
                            </div>
                            ${data.numRideAlongs > 0 ? `
                                <div style="margin-top: 10px; background: #FFCDD2; padding: 10px; border-radius: 4px; border: 2px solid #EF5350; text-align: center; font-size: 11px;">
                                    <strong>Ride Alongs (${data.numRideAlongs}):</strong> Fee: ${this.fmt(this.parseValue(calc.rideAlong))} + Bonus: ${this.fmt(this.parseValue(calc.rideAlongBonus))} = <strong>${this.fmt(data.totalRideAlongPayout)}</strong>
                                </div>
                            ` : ''}
                            <div style="margin-top: 10px; background: white; padding: 8px; border-radius: 4px; text-align: center; font-weight: 700; font-size: 12px; border: 2px solid #4CAF50;">
                                ALTA CAL Total Payout: ${this.fmt(data.altaCalTotalPayout)}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${data.additionalTeamPayout > 0 ? `
                        <div style="background: #f5f5f5; padding: 12px; border-radius: 6px; margin-bottom: 15px; border: 2px solid #333;">
                            <h3 style="margin-bottom: 10px; font-size: 14px; color: #6A1B9A;">üëî ADDITIONAL TEAM</h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; font-size: 10px;">
                                ${data.canvasserPayout > 0 ? `<div><strong>Canvasser (${calc.canvasserPercent}%):</strong> ${this.fmt(data.canvasserPayout)}</div>` : ''}
                                ${data.confirmerPayout > 0 ? `<div><strong>Confirmer (${calc.confirmerPercent}%):</strong> ${this.fmt(data.confirmerPayout)}</div>` : ''}
                                ${data.elisoPayout > 0 ? `<div><strong>Eliso (${calc.elisoPercent}%):</strong> ${this.fmt(data.elisoPayout)}</div>` : ''}
                                ${data.prodMSPayout > 0 ? `<div><strong>Prod MS:</strong> ${this.fmt(data.prodMSPayout)}</div>` : ''}
                                ${data.prodRSPayout > 0 ? `<div><strong>Prod RS:</strong> ${this.fmt(data.prodRSPayout)}</div>` : ''}
                                ${data.prodNCPayout > 0 ? `<div><strong>Prod NC:</strong> ${this.fmt(data.prodNCPayout)}</div>` : ''}
                                ${data.prodABEPayout > 0 ? `<div><strong>Prod ABE:</strong> ${this.fmt(data.prodABEPayout)}</div>` : ''}
                            </div>
                            <div style="margin-top: 8px; background: white; padding: 8px; border-radius: 4px; text-align: center; font-weight: 700; font-size: 12px; border: 2px solid #9C27B0;">
                                Additional Team Total: ${this.fmt(data.additionalTeamPayout)}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="background: #FFF9C4; padding: 12px; border-radius: 6px; border: 2px solid #F57F17; font-size: 11px; margin-bottom: 15px;">
                        <h3 style="margin-bottom: 8px; font-size: 14px; color: #F57F17;">üè¶ FINANCE & BANK INFO</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">
                            <div><strong>Money This Week:</strong> ${this.fmt(this.parseValue(calc.moneyThisWeek))}</div>
                            <div><strong>Finance Source:</strong> ${calc.financeSource || 'Not Set'}</div>
                            <div><strong>Bank Drop Day:</strong> ${calc.bankDropDay || 'Not Set'}</div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #1976D2, #0D47A1); color: white; padding: 15px; border-radius: 8px; border: 3px solid #0D47A1;">
                        <h3 style="text-align: center; margin-bottom: 12px; font-size: 14px;">üìä FINAL TOTALS</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 11px; margin-bottom: 5px;">Total Team Payout</div>
                                <div style="font-size: 20px; font-weight: 900;">${this.fmt(data.totalTeamPayout)}</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); padding: 10px; border-radius: 4px; text-align: center;">
                                <div style="font-size: 11px; margin-bottom: 5px;">Final Profit (${data.profitPercent.toFixed(1)}%)</div>
                                <div style="font-size: 20px; font-weight: 900;">${this.fmt(data.finalProfit)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('printView').innerHTML = html;
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('printView').style.display = 'block';
            
            setTimeout(() => {
                window.print();
                this.closePrint();
            }, 100);
        },
        
        showPrintReport() {
            const week = document.getElementById('collectionWeek').value || 'Not Specified';
            let totalPayout = 0, totalProfit = 0, totalMoney = 0;
            
            const rows = this.calculators.map((calc, index) => {
                const data = this.calculateOne(calc);
                totalPayout += data.totalTeamPayout;
                totalProfit += data.finalProfit;
                totalMoney += this.parseValue(calc.moneyThisWeek);
                
                return `
                    <tr>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${index + 1}</td>
                        <td style="border: 1px solid #333; padding: 8px;">${calc.jobNumber || '-'}</td>
                        <td style="border: 1px solid #333; padding: 8px;">${calc.customerName || '-'}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: right;">${this.fmt(data.contractAmount)}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: right;">${this.fmt(data.totalTeamPayout)}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: right;">${this.fmt(data.finalProfit)}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: right; font-weight: 700;">${this.fmt(this.parseValue(calc.moneyThisWeek))}</td>
                        <td style="border: 1px solid #333; padding: 8px; text-align: center;">${calc.bankDropDay || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            const html = `
                <div style="padding: 30px; font-family: Arial, sans-serif;">
                    <h1 style="text-align: center; color: #1976D2; margin-bottom: 10px;">COMBINED PROFIT REPORT</h1>
                    <h2 style="text-align: center; color: #666; margin-bottom: 25px; font-size: 16px;">Week: ${week}</h2>
                    
                    <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; margin-bottom: 25px; font-size: 13px;">
                        <thead>
                            <tr style="background: #e0e0e0;">
                                <th style="border: 1px solid #333; padding: 10px;">#</th>
                                <th style="border: 1px solid #333; padding: 10px;">Job</th>
                                <th style="border: 1px solid #333; padding: 10px;">Customer</th>
                                <th style="border: 1px solid #333; padding: 10px;">Contract</th>
                                <th style="border: 1px solid #333; padding: 10px;">Payout</th>
                                <th style="border: 1px solid #333; padding: 10px;">Profit</th>
                                <th style="border: 1px solid #333; padding: 10px;">This Week</th>
                                <th style="border: 1px solid #333; padding: 10px;">Drop Day</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows}
                            <tr style="background: #FFF9C4; font-weight: 700; font-size: 14px;">
                                <td colspan="4" style="border: 1px solid #333; padding: 10px; text-align: right;">TOTALS:</td>
                                <td style="border: 1px solid #333; padding: 10px; text-align: right;">${this.fmt(totalPayout)}</td>
                                <td style="border: 1px solid #333; padding: 10px; text-align: right;">${this.fmt(totalProfit)}</td>
                                <td style="border: 1px solid #333; padding: 10px; text-align: right;">${this.fmt(totalMoney)}</td>
                                <td style="border: 1px solid #333; padding: 10px;"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('printView').innerHTML = html;
            document.getElementById('mainView').style.display = 'none';
            document.getElementById('printView').style.display = 'block';
            
            setTimeout(() => {
                window.print();
                this.closePrint();
            }, 100);
        },
        
        closePrint() {
            document.getElementById('mainView').style.display = 'block';
            document.getElementById('printView').style.display = 'none';
        },
        
        showSaveDialog() {
            const name = prompt('Enter report name:');
            if (name && name.trim()) {
                const data = {
                    name: name.trim(),
                    date: new Date().toISOString(),
                    collectionWeek: document.getElementById('collectionWeek').value,
                    calculators: this.calculators,
                    invoiceData: {
                        jobNumber: document.getElementById('invoiceJobNumber').value,
                        contractAmount: document.getElementById('invoiceContractAmount').value,
                        contractDate: document.getElementById('contractDate').value
                    }
                };
                const key = 'report_' + Date.now();
                localStorage.setItem(key, JSON.stringify(data));
                alert('Report saved!');
            }
        }
    };
    
    window.addEventListener('DOMContentLoaded', () => app.init());
</script>
